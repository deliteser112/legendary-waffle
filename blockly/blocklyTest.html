<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>BlocklyTest</title>
  </head>
  <body>
    <div id="blocklyDiv" style="height: 480px; width: 600px;"></div>
    <textarea id="textarea"></textarea>
    <button id="run">Run</button>

    <script src="../node_modules/blockly/blockly_compressed.js"></script>
    <script src="../node_modules//blockly/blocks_compressed.js"></script>
    <script src="../node_modules/blockly/javascript_compressed.js"></script>
    <script src="../node_modules/blockly/msg/js/en.js"></script>
    <script src="./custom_blocks/custom.js"></script>

    <xml id="toolbox" style="display: none">
      <category name="Logic">
        <block type="controls_if"></block>
        <block type="controls_repeat_ext"></block>
        <block type="logic_compare"></block>
        <block type="math_number"></block>
        <block type="math_arithmetic"></block>
        <block type="text"></block>
        <block type="text_print"></block>
      </category>
      <sep></sep>
      <category name="Movement" colour="210">
        <block type="move"></block>
        <block type="rotate"></block>
      </category>
    </xml>

    <script>
      var workspace = Blockly.inject('blocklyDiv',
        {toolbox: document.getElementById('toolbox')})

      //workspace.addChangeListener(myUpdateFunction)

      document.getElementById('run').onclick = function () {
        myUpdateFunction()
      }

      Blockly.JavaScript['move'] = function(block) {
        var dropdown_move = block.getFieldValue('Move')
        return 'moveInDir(' + '"' + dropdown_move + '"' + ')\n'
      }

      Blockly.JavaScript['rotate'] = function(block) {
        var dropdown_direction = block.getFieldValue('Direction');
        return 'rotateInDir(' + '"' + dropdown_direction + '"' + ')\n';
      };

      function myUpdateFunction(event) {
        var code = Blockly.JavaScript.workspaceToCode(workspace)
        document.getElementById('textarea').value = code
        eval(code)
      }

      function moveInDir (dir) {
        switch (dir) {
          case'LEFT':
            console.log('move left')
            break
          case'RIGHT':
            console.log('move right')
            break
          case'UP':
            console.log('move up')
            break
          case'DOWN':
            console.log('move down')
            break
        }
      }

      function rotateInDir (dir) {
        switch (dir) {
          case'LEFT':
            console.log('rotate left')
            break
          case'RIGHT':
            console.log('rotate right')
            break
        }
      }
      </script>
  </body>
</html>
